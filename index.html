<!-- index.html (FINAL, copy-paste)
     PERSONAL OS — iOS PWA (Vanilla) — Stabilized Shell
     Wichtige Punkte:
     - GH Pages Subpath safe (relative paths)
     - Keine ES-Module
     - Crash-safe Nav Sync via Router + personalos:navigated
     - Dashboard ist Startscreen (kein Tab)
     - Vault Screen eingebunden
-->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Personal OS</title>

  <!-- PWA / iOS -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#F6F5F2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Personal OS" />
  <link rel="apple-touch-icon" href="./assets/icons/icon-192.png" />

  <link rel="stylesheet" href="./css/styles.css" />
</head>

<body>
  <div class="app-shell">
    <!-- App content root: Router mounts screens here -->
    <main id="app-content" class="app-content" aria-label="App content">
      <!-- Router will render dashboard here on boot -->
      <div class="dash-card" style="margin-top: 12px;">
        <div style="font-weight:900;">Loading…</div>
        <div style="font-size:13px; opacity:0.75; margin-top:6px;">
          Wenn dieser Screen hängen bleibt: Service Worker Cache löschen (System → Clear Cache) oder Hard Reload.
        </div>
      </div>
    </main>

    <!-- Bottom navigation: Dashboard is NOT a tab -->
    <nav class="bottom-nav" aria-label="Bottom navigation">
      <button class="nav-btn" type="button" data-target="mindset" aria-label="Mindset">
        <span class="nav-icon">◻︎</span>
        <span class="nav-text">Mindset</span>
      </button>

      <button class="nav-btn" type="button" data-target="path" aria-label="Today’s Path">
        <span class="nav-icon">↦</span>
        <span class="nav-text">Today</span>
      </button>

      <button class="nav-btn" type="button" data-target="maintenance" aria-label="Maintenance">
        <span class="nav-icon">⚙︎</span>
        <span class="nav-text">System</span>
      </button>

      <button class="nav-btn" type="button" data-target="finance" aria-label="Finance">
        <span class="nav-icon">◎</span>
        <span class="nav-text">Finance</span>
      </button>
    </nav>
  </div>

  <!-- Core (NO modules, correct load order) -->
  <script src="./js/core/state.js"></script>
  <script src="./js/core/registry.js"></script>
  <script src="./js/core/router.js"></script>

  <!-- Screens (register only) -->
  <script src="./js/screens/dashboard.js"></script>
  <script src="./js/screens/mindset.js"></script>
  <script src="./js/screens/path.js"></script>
  <script src="./js/screens/maintenance.js"></script>
  <script src="./js/screens/finance.js"></script>
  <script src="./js/screens/vault.js"></script>

  <!-- Boot LAST -->
  <script src="./js/core/boot.js"></script>

  <!-- Bottom Nav + Active State Sync (crash-safe, iOS touch-safe) -->
  <script>
    (function () {
      "use strict";

      var TAB_SCREENS = { mindset: true, path: true, maintenance: true, finance: true };

      function setActiveTab(screenName) {
        try {
          var btns = document.querySelectorAll(".nav-btn");
          for (var i = 0; i < btns.length; i++) btns[i].classList.remove("active");

          if (!TAB_SCREENS[screenName]) return; // Dashboard/Vault => no active tab

          var btn = document.querySelector('.nav-btn[data-target="' + screenName + '"]');
          if (btn) btn.classList.add("active");
        } catch (e) {
          console.error("setActiveTab error", e);
        }
      }

      function bindNav() {
        try {
          var btns = document.querySelectorAll(".nav-btn");
          for (var i = 0; i < btns.length; i++) {
            (function (btn) {
              function handler(e) {
                try {
                  if (e && e.preventDefault) e.preventDefault();
                  var target = btn.getAttribute("data-target");
                  if (!target) return;

                  setActiveTab(target);

                  if (window.Router && typeof window.Router.go === "function") {
                    window.Router.go(target);
                  }
                } catch (err) {
                  console.error("nav handler error", err);
                }
              }

              btn.addEventListener("click", handler, { passive: false });
              btn.addEventListener("touchend", handler, { passive: false });
            })(btns[i]);
          }
        } catch (e) {
          console.error("bindNav failed", e);
        }
      }

      // Hook Router.go so tab highlight stays correct even when navigation happens via buttons inside screens
      function hookRouter() {
        try {
          if (!window.Router || typeof window.Router.go !== "function") return;

          if (window.Router.__navHooked) return;
          window.Router.__navHooked = true;

          var originalGo = window.Router.go;

          window.Router.go = function (screenName) {
            try { setActiveTab(String(screenName || "")); } catch (_) {}
            try { return originalGo.apply(window.Router, arguments); }
            catch (e) { console.error("Router.go wrapper error", e); }
          };
        } catch (e) {
          console.error("hookRouter failed", e);
        }
      }

      // Also sync via event fired after navigation (Router dispatches personalos:navigated)
      function bindNavSyncEvent() {
        try {
          window.addEventListener("personalos:navigated", function (ev) {
            try {
              var s = ev && ev.detail && ev.detail.screen ? String(ev.detail.screen) : "";
              setActiveTab(s);
            } catch (_) {}
          });
        } catch (_) {}
      }

      bindNav();
      hookRouter();
      bindNavSyncEvent();

      // Start: dashboard => no active tab
      setActiveTab("dashboard");
    })();
  </script>
</body>
</html>
